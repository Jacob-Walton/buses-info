@page "/admin/apimanagement"
@model BusInfo.Pages.Admin.ApiManagementModel
@{
    ViewData["Title"] = "API Management";
}

<div class="admin-layout">
    <aside class="admin-sidebar">
        <!-- ...existing sidebar code from Index.cshtml... -->
    </aside>

    <main class="admin-content">
        <header class="admin-header">
            <div class="admin-header__title">
                <h1>
                    <i class="fas fa-key"></i>
                    API Management
                </h1>
                <div class="breadcrumb">
                    <a href="/admin">Admin</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>API Management</span>
                </div>
            </div>

            <div class="admin-header__actions">
                <button id="refreshApiDataButton" class="admin-btn admin-btn--outline">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </header>

        <div class="admin-sections">
            <!-- API Keys Section -->
            <div class="admin-section">
                <div class="admin-section__header">
                    <h2 class="admin-section__title">Active API Keys</h2>
                </div>
                <div class="admin-section__content">
                    <div class="admin-table-wrapper">
                        <table class="admin-table responsive">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Usage Today</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var key in Model.ApiKeys)
                                {
                                    <tr>
                                        <td data-label="User">@key.UserEmail</td>
                                        <td data-label="Usage">@key.RequestsToday.ToString("N0")</td>
                                        <td data-label="Status">
                                            <span class="table-status table-status--@(key.IsActive ? "success" : "danger")">
                                                @(key.IsActive ? "Active" : "Revoked")
                                            </span>
                                        </td>
                                        <td data-label="Actions" class="actions">
                                            <button class="admin-btn admin-btn--primary admin-btn--sm js-view-usage" data-key="@key.Key">
                                                <i class="fas fa-chart-bar"></i>
                                                <span>Usage</span>
                                            </button>
                                            @if (key.IsActive)
                                            {
                                                <button class="admin-btn admin-btn--danger admin-btn--sm js-revoke-key" data-key="@key.Key">
                                                    <i class="fas fa-ban"></i>
                                                    <span>Revoke</span>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- API Requests Section -->
            <div class="admin-section">
                <div class="admin-section__header">
                    <h2 class="admin-section__title">Pending Requests</h2>
                </div>
                <div class="admin-section__content">
                    <div class="admin-table-wrapper">
                        <table class="admin-table responsive">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Requested</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var request in Model.PendingRequests)
                                {
                                    <tr>
                                        <td data-label="User">@request.UserEmail</td>
                                        <td data-label="Requested">@request.RequestedTimeAgo</td>
                                        <td data-label="Actions" class="actions">
                                            <button class="admin-btn admin-btn--success admin-btn--sm js-approve-request" data-request-id="@request.Id">
                                                <i class="fas fa-check"></i>
                                                <span>Approve</span>
                                            </button>
                                            <button class="admin-btn admin-btn--danger admin-btn--sm js-reject-request" data-request-id="@request.Id">
                                                <i class="fas fa-times"></i>
                                                <span>Reject</span>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Usage Details Modal -->
<div id="usageModal" class="admin-modal">
    <div class="admin-modal__content">
        <div class="admin-modal__header">
            <h3 class="admin-modal__title">API Key Usage Details</h3>
            <button class="admin-modal__close js-close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal__body">
            <div id="usageDetails"></div>
        </div>
    </div>
</div>

<!-- Reject Request Modal -->
<div id="rejectModal" class="admin-modal">
    <div class="admin-modal__content">
        <div class="admin-modal__header">
            <h3 class="admin-modal__title">Reject API Key Request</h3>
            <button class="admin-modal__close js-close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="admin-modal__body">
            <form id="rejectForm">
                <input type="hidden" id="rejectRequestId" />
                <div class="admin-form__group">
                    <label for="rejectReason">Reason for Rejection</label>
                    <textarea id="rejectReason" class="admin-form__input" rows="4" required></textarea>
                </div>
                <div class="admin-form__actions">
                    <button type="button" class="admin-btn admin-btn--outline js-close-modal">Cancel</button>
                    <button type="submit" class="admin-btn admin-btn--danger">Reject Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirmation Modal Template -->
<template id="confirmModalTemplate">
    <div class="admin-modal">
        <div class="admin-modal__content">
            <div class="admin-modal__header">
                <h3 class="admin-modal__title"></h3>
                <button class="admin-modal__close js-close-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="admin-modal__body">
                <div class="admin-confirm">
                    <div class="admin-confirm__icon">
                        <i class="fas"></i>
                    </div>
                    <div class="admin-confirm__message"></div>
                </div>
            </div>
            <div class="admin-modal__footer">
                <button class="admin-btn admin-btn--outline js-cancel-action">Cancel</button>
                <button class="admin-btn js-confirm-action">Confirm</button>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script src="~/js/admin/apiManagement.js" asp-append-version="true"></script>
}

@section Head {
    <link rel="stylesheet" href="/css/admin/admin.css" />
}
